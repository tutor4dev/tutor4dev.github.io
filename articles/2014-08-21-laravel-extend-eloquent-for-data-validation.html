<!DOCTYPE html>
<html lang="th-TH">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Customize Eloquent เพื่อทำ Data Validation | tutor4dev</title>
    <meta name="description" content="คอร์สอบรม, บทความ และคลิปวีดีโอการพัฒนาเว็บแอพพลิเคชั่น - Customize Eloquent เพื่อทำ Data Validation">
    <meta property="og:locale" content="th_TH">
  <meta property="og:type" content="article">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kanit|Source+Code+Pro">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.1bd31715.css" as="style"><link rel="preload" href="/assets/js/app.6167409c.js" as="script"><link rel="preload" href="/assets/js/11.338da4e5.js" as="script"><link rel="prefetch" href="/assets/js/10.e473d875.js"><link rel="prefetch" href="/assets/js/12.4d2d3e07.js"><link rel="prefetch" href="/assets/js/13.09b2662a.js"><link rel="prefetch" href="/assets/js/14.dcf83a65.js"><link rel="prefetch" href="/assets/js/15.58983bc6.js"><link rel="prefetch" href="/assets/js/16.c4f98dd5.js"><link rel="prefetch" href="/assets/js/17.a9027670.js"><link rel="prefetch" href="/assets/js/18.400827b4.js"><link rel="prefetch" href="/assets/js/19.d34c9422.js"><link rel="prefetch" href="/assets/js/2.685047b3.js"><link rel="prefetch" href="/assets/js/20.842922a7.js"><link rel="prefetch" href="/assets/js/21.75da3bb5.js"><link rel="prefetch" href="/assets/js/22.01a12130.js"><link rel="prefetch" href="/assets/js/23.bc8e421d.js"><link rel="prefetch" href="/assets/js/24.69e3ab87.js"><link rel="prefetch" href="/assets/js/25.3f6f2b4d.js"><link rel="prefetch" href="/assets/js/26.76873050.js"><link rel="prefetch" href="/assets/js/27.d9ed80ac.js"><link rel="prefetch" href="/assets/js/28.3fe570c4.js"><link rel="prefetch" href="/assets/js/29.e02f2376.js"><link rel="prefetch" href="/assets/js/3.4db2f7d7.js"><link rel="prefetch" href="/assets/js/30.5fbf87ee.js"><link rel="prefetch" href="/assets/js/31.0d2956b0.js"><link rel="prefetch" href="/assets/js/32.203b35d6.js"><link rel="prefetch" href="/assets/js/33.61179e1b.js"><link rel="prefetch" href="/assets/js/34.a458a5b3.js"><link rel="prefetch" href="/assets/js/35.4f635ec8.js"><link rel="prefetch" href="/assets/js/36.a3ce0214.js"><link rel="prefetch" href="/assets/js/37.4a3f7f96.js"><link rel="prefetch" href="/assets/js/38.44dc4674.js"><link rel="prefetch" href="/assets/js/39.0e7b485a.js"><link rel="prefetch" href="/assets/js/4.5b6ca910.js"><link rel="prefetch" href="/assets/js/40.230928b3.js"><link rel="prefetch" href="/assets/js/41.9e50c73c.js"><link rel="prefetch" href="/assets/js/42.7354a5c6.js"><link rel="prefetch" href="/assets/js/43.73277d04.js"><link rel="prefetch" href="/assets/js/44.ada7bb99.js"><link rel="prefetch" href="/assets/js/45.bd75a18b.js"><link rel="prefetch" href="/assets/js/5.7f6cc5a1.js"><link rel="prefetch" href="/assets/js/6.1e265201.js"><link rel="prefetch" href="/assets/js/7.efd3ea39.js"><link rel="prefetch" href="/assets/js/8.0ab33745.js"><link rel="prefetch" href="/assets/js/9.3f89266c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1bd31715.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><!----> <nav role="navigation" aria-label="main navigation" class="navbar" data-v-2f76792c><div class="navbar-brand" style="margin-left:2em;" data-v-2f76792c><a href="https://twitter.com/tutor4dev" target="_blank" class="navbar-item is-hidden-desktop" data-v-2f76792c><span class="icon" style="color:#55acee;" data-v-2f76792c><i class="fa fa-lg fa-twitter" data-v-2f76792c></i></span></a><a href="https://fb.com/tutor4dev" target="_blank" class="navbar-item is-hidden-desktop" data-v-2f76792c><span class="icon" style="color:#4267b2;" data-v-2f76792c><i class="fa fa-lg fa-facebook" data-v-2f76792c></i></span></a><a href="https://www.youtube.com/user/tutor4dev/videos" target="_blank" class="navbar-item is-hidden-desktop" data-v-2f76792c><span class="icon" style="color:#ff0000;" data-v-2f76792c><i class="fa fa-lg fa-youtube" data-v-2f76792c></i></span></a> <button data-target="navMenu" class="button navbar-burger false" data-v-2f76792c><span data-v-2f76792c></span> <span data-v-2f76792c></span> <span data-v-2f76792c></span></button></div> <div id="navMenu" class="navbar-menu false" data-v-2f76792c><a href="/" class="router-link-active navbar-item is-tab" data-v-2f76792c>หน้าหลัก</a> <!----> <!----><!----> <a href="https://www.youtube.com/user/tutor4dev/videos" target="_blank" class="navbar-item is-tab" data-v-2f76792c>YouTube</a> <!----><a href="/articles.html" class="navbar-item is-tab is-active" data-v-2f76792c>บทความ</a> <!----> <!----><!----> <!----><!----> <!----><!----> <!----><!----> <!----><a href="/about.html" class="navbar-item is-tab" data-v-2f76792c>เกี่ยวกับเรา</a> <!----> <!----></div></nav> <section class="section" style="padding-top:0.5em;"><div class="container"><div class="columns"><div class="column is-three-quarters"><div class="is-article"><p style="margin-bottom:2em;"></p> <div class="content custom"><h1>Customize Eloquent เพื่อทำ Data Validation</h1> <p>การทำ Data Validation ก่อนการจัดเก็บเข้าฐานข้อมูลเป็นสิ่งจำเป็นและไม่ควรละเลยอย่างยิ่ง Coding ส่วนนี้ไม่ว่าจะเป็น Model ใด ก็จะแทบจะมี Coding เหมือนกัน เพื่อลดความซ้ำซ้อนตามหลักการของ OOP เราน่าจะย้าย Coding ตรงส่วนนี้มาไว้กับ Parent Class ซึ่ง Inherit มาจาก Eloquent โดยให้ Model ทุกตัวใน Project เปลี่ยนมา Inherit Class นี้แทนการ Inherit จาก Eloquent โดยตรง</p> <h3 id="วิธีการ-coding-แบบเดิม">วิธีการ Coding แบบเดิม</h3> <p>ก่อนหน้านี้ผม Coding ทุกอย่างไว้ที่ Controller ทั้ง <code>$rules</code>, <code>$messages</code> และ การประมวลผล Validation</p> <div class="language-php extra-class"><pre class="hljs"><code>
<span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postSaveToDatabase</span><span class="hljs-params">()</span> </span>{
        Inputs = Input::all();

        $rules = <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'room_desc'</span> =&gt; <span class="hljs-string">'required'</span>,
            <span class="hljs-string">'room_status'</span> =&gt; <span class="hljs-string">'required'</span>,
        );

        $messages = <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'room_desc.required'</span> =&gt; <span class="hljs-string">'กรุณากรอกข้อมูลรายละเอียดห้องพัก'</span>,
            <span class="hljs-string">'room_status.required'</span> =&gt; <span class="hljs-string">'กรุณากรอกข้อมูลสถานะห้องพัก'</span>,
        );

        $validator = Validator::make(Input::all(), $rules);

        <span class="hljs-keyword">if</span> ($validator-&gt;passes()) {
            <span class="hljs-comment">// ผ่านการ Validate ทำการจัดเก็บข้อมูลต่อไป</span>
        } <span class="hljs-keyword">else</span> {
            dd($validator-&gt;messages());
        }
    }
}
</code></pre></div><blockquote><p>ปกติ Controller ถูกออกแบบมาให้เป็นที่สำหรับ Coding Logic การประกาศตัวแปรสำหรับ Rules, Messages ไม่ค่อยถูกหลักนักที่จะมาประกาศไว้ที่นี่ อีกทั้ง Processs การทำ Validation ไม่ว่าจะเป็น Model ไหนก็จะมี Coding ลักษณะเดียวกัน เพื่อลดความซ้ำซ้อนของ Coding ส่วนนี้เราน่าจะมี Class ที่เป็น Parent Class ของทุก Model</p></blockquote> <h3 id="เปลี่ยนมา-inherit-basemodel-แทน-eloquent">เปลี่ยนมา Inherit BaseModel แทน Eloquent</h3> <p>ก่อนที่จะพูดถึง Class <code>BaseModel</code> เราจะแก้ไข Coding ของ Class <code>Room</code> ซึ่งเป็น Model จากที่เคย Inherit <code>Eloquent</code> มา Inherit <code>BaseModel</code> แทน โดยเราจะประกาศ <code>$rules</code> และ <code>$messages</code> ไว้ที่นี่ซะเลย</p> <div class="language-php extra-class"><pre class="hljs"><code>
<span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseModel</span> </span>{
    <span class="hljs-comment">/**
        กำหนดค่า Rules และ Messages ไว้ที่ Model ซะเลย
    */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> $rules = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'room_desc'</span> =&gt; <span class="hljs-string">'required'</span>,
        <span class="hljs-string">'room_status'</span> =&gt; <span class="hljs-string">'required'</span>
    );

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> $messages = <span class="hljs-keyword">array</span>(
        <span class="hljs-string">'room_desc.required'</span> =&gt; <span class="hljs-string">'กรุณากรอกข้อมูลรายละเอียดห้องพัก'</span>,
        <span class="hljs-string">'room_status.required'</span> =&gt; <span class="hljs-string">'กรุณากรอกข้อมูลสถานะห้องพัก'</span>,
    );
}
</code></pre></div><h3 id="สร้าง-class-basemodel">สร้าง Class BaseModel</h3> <p>Class นี้จะมี Public Function ที่สำคัญคือ <code>saveWithValidate()</code> เอาไว้สำหรับการเรียกใช้เวลาจะจัดเก็บข้อมูลแบบมีการทำ Validation (ก่อนที่จะจัดเก็บเข้าฐานข้อมูล) และ Public Function <code>getErrors()</code> เอาไว้ดึง Error Message ในกรณีที่ Validate ไม่ผ่าน</p> <div class="language-php extra-class"><pre class="hljs"><code>
<span class="hljs-meta">&lt;?php</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Eloquent</span> </span>{
    <span class="hljs-keyword">protected</span> $errors;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> $rules = <span class="hljs-keyword">array</span>();
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> $messages = <span class="hljs-keyword">array</span>();
    <span class="hljs-keyword">protected</span> $validator;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(array $attributes = array<span class="hljs-params">()</span>, Validator $validator = null)</span> </span>{
        <span class="hljs-keyword">parent</span>::__construct($attributes);

        <span class="hljs-keyword">$this</span>-&gt;validator = $validator ?: \App::make(<span class="hljs-string">'validator'</span>);
    }

    <span class="hljs-comment">/**
        สร้าง Public Function เพื่อเรียกใช้แทนการเรียก save()
    */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveWithValidate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;validate()) {
            <span class="hljs-comment">// ถ้าผ่าน Validation ก็จะเรียกใช้ save() ของ Eloquent</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;save()) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-comment">/**
        ในกรณีที่ไม่ผ่านการ Validate เราจะใช้ Function นี้ในการดึงข้อความ Error
    */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getErrors</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;errors;
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setErrors</span><span class="hljs-params">($errors)</span> </span>{
        <span class="hljs-keyword">$this</span>-&gt;errors = $errors;
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate</span><span class="hljs-params">()</span> </span>{
        $validator = <span class="hljs-keyword">$this</span>-&gt;validator-&gt;make(<span class="hljs-keyword">$this</span>-&gt;attributes, <span class="hljs-keyword">static</span>::$rules, <span class="hljs-keyword">static</span>::$messages);

        <span class="hljs-keyword">if</span> ($validator-&gt;passes()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }

        <span class="hljs-keyword">$this</span>-&gt;setErrors($validator-&gt;messages());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }
    }
}
</code></pre></div><h3 id="แก้ไข-coding-ใน-controller">แก้ไข Coding ใน Controller</h3> <p>เมื่อเราวางทุกอย่างไว้เรียบร้อยแล้ว เราก็เพียงเรียกใช้ <code>$room-&gt;saveWithValidate()</code> ส่วนการทำ Validation นั้น Class <code>BaseModel</code> จะจัดการให้เอง สะดวกดีแท้</p> <div class="language-php extra-class"><pre class="hljs"><code>
$room = <span class="hljs-keyword">new</span> Room();

$room-&gt;room_desc = Input::get(<span class="hljs-string">'room_desc'</span>);
<span class="hljs-comment">// $room-&gt;room_status = Input::get('room_status');</span>

<span class="hljs-keyword">if</span> (!$room-&gt;saveWithValidate()) {
    dd($room-&gt;getErrors());
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Success'</span>;
}
</code></pre></div><h3 id="error-message">Error Message</h3> <p>เมื่อทดลองเรียกใช้ <code>saveWithValidate()</code> โดยที่ป้อนข้อมูลไม่ครบ ก็จะเกิด Error Message ประมาณ Snippet ด้านล่าง</p> <div class="language-php extra-class"><pre class="hljs"><code>
object(Illuminate\Support\MessageBag)<span class="hljs-comment">#237 (2) {</span>
    [<span class="hljs-string">&quot;messages&quot;</span>:<span class="hljs-keyword">protected</span>]=&gt; <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) {
        [<span class="hljs-string">&quot;room_status&quot;</span>]=&gt; <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) {
            [<span class="hljs-number">0</span>]=&gt; string(<span class="hljs-number">27</span>) <span class="hljs-string">&quot;กรุณากรอกข้อมูลสถานะห้องพัก&quot;</span>
        }
    }

    [<span class="hljs-string">&quot;format&quot;</span>:<span class="hljs-keyword">protected</span>]=&gt; string(<span class="hljs-number">8</span>) <span class="hljs-string">&quot;:message&quot;</span>
}
</code></pre></div><h3 id="บทสรุป">บทสรุป</h3> <p>เป็นสิ่งจำเป็นอย่างยิ่งที่ควรจะมีการทำ Validation ทุกครั้งก่อนที่จะมีการจัดเก็บข้อมูลเข้าฐานข้อมูล บ่อยครั้งที่การจัดเก็บข้อมูล Model เดียวกัน มีการกระจายอยู่ในหลาย Controller การเพิ่ม Class <code>BaseModel</code> จะช่วยลดความซ้ำซ้อนตรงส่วนนี้ได้เป็นอย่างดี และ ยังช่วยให้การ Coding ที่ Controller ดูสบายตาเป็นอย่างมาก ง่ายต่อการ Maintainace Coding ในอนาคต</p> <blockquote><p>Code ตัวอย่างในบทความนี้ถูกทดสอบบน Laravel 4.2.x</p></blockquote></div></div></div> <div class="column is-hidden-mobile"><p style="margin-bottom:2em"></p> <!----></div></div></div></section> <!----></div></div>
    <script src="/assets/js/app.6167409c.js" defer></script><script src="/assets/js/11.338da4e5.js" defer></script>
  </body>
</html>
